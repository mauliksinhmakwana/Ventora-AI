<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula AI</title>
    <style>
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border: rgba(255, 255, 255, 0.1);
            --accent-blue: #007aff;
            --glass: rgba(255, 255, 255, 0.03);
            --code-bg: #1a1a1a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg); color: var(--text-primary);
            height: 100dvh; /* Better mobile height */
            display: flex; flex-direction: column; overflow: hidden;
        }
        /* --- BACKGROUND --- */
        .stars-container {
            position: fixed; top: 0; left: 0; width: 200%; height: 200%; z-index: -1;
            background-image: radial-gradient(1px 1px at 20px 30px, #fff, rgba(0,0,0,0)),
                              radial-gradient(1.2px 1.2px at 40px 70px, #fff, rgba(0,0,0,0)),
                              radial-gradient(1.5px 1.5px at 150px 150px, #fff, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 300px 300px;
            animation: drift 120s linear infinite; opacity: 0.4;
        }
        @keyframes drift { from { transform: translate(0, 0); } to { transform: translate(-300px, -300px); } }
        .nebula-glow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% 50%, rgba(50, 50, 150, 0.1), transparent 70%); }
        /* --- HEADER --- */
        header {
            position: fixed; top: 0; width: 100%; z-index: 1000; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .version-badge {
            font-size: 0.6rem; background: rgba(255,255,255,0.1); padding: 2px 8px;
            border-radius: 4px; color: var(--text-secondary); letter-spacing: 1px;
            border: 1px solid var(--border);
        }
        /* --- MAIN CHAT --- */
        main {
            flex: 1; margin-top: 60px; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 24px; width: 100%;
            max-width: 800px; align-self: center; scrollbar-width: none;
        }
        main::-webkit-scrollbar { display: none; }
        .msg-wrapper {
            display: flex; flex-direction: column; width: 100%; animation: fadeIn 0.4s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg {
            max-width: 90%; line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; position: relative;
        }
        .user { align-self: flex-end; border-right: 2px solid white; padding-right: 15px; text-align: right; }
        .ai { align-self: flex-start; border-left: 1px solid var(--border); padding-left: 15px; color: var(--text-secondary); }
        .timestamp {
            font-size: 0.65rem; color: #666; margin-top: 6px; opacity: 0.8;
        }
        .regenerate-btn {
            cursor: pointer; font-size: 0.8rem; color: var(--accent-blue); margin-top: 8px; opacity: 0.7;
            transition: opacity 0.2s;
        }
        .regenerate-btn:hover { opacity: 1; }
        /* --- CODE BLOCK --- */
        .code-container {
            background: var(--code-bg); border-radius: 8px; margin: 10px 0;
            border: 1px solid var(--border); overflow: hidden;
        }
        .code-header {
            background: rgba(255,255,255,0.05); padding: 8px 15px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: var(--text-secondary);
        }
        .copy-btn { cursor: pointer; color: var(--text-primary); font-weight: bold; }
        pre { margin: 0; padding: 15px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; color: #dcdcdc; }
        /* --- TYPING INDICATOR --- */
        .typing-dots {
            display: inline-flex; gap: 4px; align-items: center;
        }
        .typing-dots span {
            width: 6px; height: 6px; background: #888; border-radius: 50%;
            display: inline-block; animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        /* --- BOTTOM INPUT --- */
        .bottom-section {
            z-index: 1001; background: linear-gradient(transparent, var(--bg) 20%);
            display: flex; flex-direction: column; align-items: center;
            padding: 10px 20px 20px 20px; /* Increased bottom padding */
            width: 100%;
        }
        .input-section {
            width: 100%; max-width: 800px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 0; /* Important for flex on mobile */
        }
        .clear-bar {
            width: 100%; display: flex; justify-content: flex-end; margin-bottom: 8px;
        }
        .tiny-new-chat {
            font-size: 0.6rem; color: var(--accent-blue); cursor: pointer;
            border: 1px solid rgba(0,122,255,0.3); padding: 2px 8px; border-radius: 10px;
            text-transform: uppercase; letter-spacing: 1px; background: rgba(0,122,255,0.05);
        }
        .input-bar {
            width: 100%; background: rgba(255,255,255,0.07);
            border: 1px solid var(--border); border-radius: 24px;
            display: flex; align-items: flex-end; padding: 10px 12px 10px 18px;
            overflow: visible; /* Ensure nothing is clipped */
        }
        textarea {
            flex: 1; background: transparent; border: none; color: white;
            padding: 8px 0; font-size: 1rem; outline: none; resize: none;
            max-height: 150px; font-family: inherit; line-height: 1.4;
        }
        #send-btn {
            background: white; color: black; border: none; width: 36px; height: 36px;
            border-radius: 50%; cursor: pointer; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; margin-left: 10px;
            transition: transform 0.1s;
        }
        #send-btn:active { transform: scale(0.92); }
        .footer-info {
            margin-top: 12px; font-size: 0.65rem; color: var(--text-secondary); text-align: center;
        }
        #scroll-down-btn {
            position: fixed; bottom: 160px; right: 20px; z-index: 999;
            background: white; color: black; border: none; width: 32px; height: 32px;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
        }

        /* MOBILE FIXES */
        @media (max-width: 480px) {
            .bottom-section {
                padding-bottom: max(20px, env(safe-area-inset-bottom)); /* Extra safe space */
            }
            .input-bar {
                padding: 10px 8px 10px 14px;
            }
            #send-btn {
                width: 34px; height: 34px; margin-left: 8px;
            }
            textarea {
                font-size: 0.95rem; /* Prevents iOS zoom */
            }
            .footer-info { font-size: 0.6rem; }
            main { padding: 15px; }
            header { padding: 0 15px; }
        }
    </style>
</head>
<body onload="loadChat()">
    <div class="stars-container"></div>
    <div class="nebula-glow"></div>
    <button id="scroll-down-btn" onclick="scrollToBottom()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </button>
    <header>
        <div class="logo-area" style="display: flex; align-items: baseline; gap: 12px;">
            <div class="logo" style="font-size: 1.1rem; letter-spacing: 4px; color: var(--text-primary);">
                NEBULA<b style="color: var(--accent-blue);">AI</b>
            </div>
            <div class="version-badge" style="opacity: 0.7; font-weight: 600;">
                V2.0 Enhanced
            </div>
        </div>
        <button class="icon-btn" onclick="shareApp()" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 6px 16px; border-radius: 12px; font-weight: 700; font-size: 0.6rem; letter-spacing: 1px; backdrop-filter: blur(10px); color: white; cursor: pointer;">
            SHARE
        </button>
    </header>
    <main id="chat-container"></main>
    <div class="bottom-section">
        <div class="input-section">
            <div class="clear-bar">
                <div class="tiny-new-chat" onclick="newChat()">New Chat</div>
            </div>
            <div class="input-bar">
                <textarea id="user-input" rows="1" placeholder="Type a message..." oninput="autoExpand(this)"></textarea>
                <button id="send-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <div class="footer-info">
                Created by <b>Maulik Makwana</b> • Powered by Groq • Nebula AI can make mistakes.
            </div>
        </div>
    </div>
    <script>
        // === IMPORTANT SECURITY FIX ===
        // Your API key is no longer here!
        // Create a free backend proxy at: https://vercel.com or https://netlify.com
        // Example proxy URL (replace with your own):
        const PROXY_URL = 'https://your-vercel-or-netlify-url.vercel.app/api/chat';
        const MODEL_ID = 'llama-3.1-8b-instant';
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const scrollBtn = document.getElementById('scroll-down-btn');
        function autoExpand(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }
        function getTime() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        function formatAIResponse(text) {
            const codeRegex = /```(\w*)\n([\s\S]*?)```/g;
            return text.replace(codeRegex, (match, lang, code) => {
                const id = 'code-' + Math.random().toString(36).substr(2, 9);
                return `
                <div class="code-container">
                    <div class="code-header">
                        <span>${lang.toUpperCase() || 'CODE'}</span>
                        <span class="copy-btn" onclick="copyCode('${id}')">COPY</span>
                    </div>
                    <pre id="${id}">${code.trim()}</pre>
                </div>`;
            });
        }
        function copyCode(id) {
            const code = document.getElementById(id).innerText;
            navigator.clipboard.writeText(code);
            alert('Code copied!');
        }
        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
        chatContainer.onscroll = () => {
            const diff = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight;
            scrollBtn.style.display = diff > 100 ? 'flex' : 'none';
        };
        function saveChat() {
            localStorage.setItem('nebula_chat_history', chatContainer.innerHTML);
        }
        function loadChat() {
            const saved = localStorage.getItem('nebula_chat_history');
            if (saved && saved.trim()) {
                chatContainer.innerHTML = saved;
                scrollToBottom();
            } else {
                appendMessage('Hello! I am Nebula AI. How can I assist you today?', 'ai');
            }
        }
        function newChat() {
            if (confirm("Start a new conversation? Current chat will be saved.")) {
                chatContainer.innerHTML = '';
                appendMessage('New conversation started. How can I help?', 'ai');
                saveChat();
            }
        }
        async function handleSend(lastUserMessage = null) {
            const query = lastUserMessage || userInput.value.trim();
            if (!query) return;
            if (!lastUserMessage) {
                appendMessage(query, 'user');
                userInput.value = '';
                userInput.style.height = 'auto';
            }
            const loadingMsg = appendMessage(
                '<div class="typing-dots"><span></span><span></span><span></span></div>', 'ai'
            );
            saveChat();
            try {
                const response = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model: MODEL_ID, message: query })
                });
                if (!response.ok) throw new Error("API error");
                const data = await response.json();
                const rawText = data.content || "No response.";
                loadingMsg.innerHTML = formatAIResponse(rawText) +
                    `<div class="timestamp">${getTime()}</div>` +
                    `<div class="regenerate-btn" onclick="regenerate(this)">↻ Regenerate</div>`;
                saveChat();
                scrollToBottom();
            } catch (err) {
                loadingMsg.innerHTML = `Error: Could not connect. Check your proxy.`;
            }
        }
        function regenerate(btn) {
            const wrapper = btn.closest('.msg-wrapper');
            const userMsg = wrapper.previousElementSibling?.querySelector('.msg')?.innerText;
            if (userMsg) {
                wrapper.remove();
                handleSend(userMsg);
            }
        }
        function appendMessage(text, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${type}-wrapper`;
            const msg = document.createElement('div');
            msg.className = `msg ${type}`;
            if (type === 'ai') {
                msg.innerHTML = text + (type === 'ai' && !text.includes('typing-dots') ? `<div class="timestamp">${getTime()}</div>` : '');
            } else {
                msg.innerText = text;
                msg.innerHTML += `<div class="timestamp">${getTime()}</div>`;
            }
            wrapper.appendChild(msg);
            chatContainer.appendChild(wrapper);
            scrollToBottom();
            return msg;
        }
        function shareApp() {
            if (navigator.share) {
                navigator.share({ title: 'Nebula AI', url: window.location.href });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert("Link copied to clipboard!");
            }
        }
        // Event Listeners
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
        sendBtn.addEventListener('click', handleSend);
    </script>
</body>
</html>
